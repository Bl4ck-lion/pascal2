---
import Layout from "../layouts/Layout.astro";
import { Icon } from "astro-icon";
---

<Layout>
	<h2 class="Neohellenic-700 text-4xl font-bold underline text-center mt-4 drop-shadow-lg">Growtopia Reminder</h2>
	<h1 class="text-center text-sm max-w-[80%] md:max-w-[60%] lg:max-w-[40%] self-center text-slate-300 mx-6 drop-shadow-md">Before you could access this page, you need to login using your google account and license key. To obtain the license, you could contact me at my <span class="underline">Discord.</span></h1>
	<div class="w-full h-full flex justify-center">
		<div class="max-w-[60%] flex flex-1 flex-col justify-center">
			<button
				id="login"
				disabled="true"
				onclick="login()"
				class="max-h-16 m-2 p-4 border-white border-solid border-2 rounded-md flex-1 mx-4 bg-slate-700 shadow-md transition-all duration-200 hover:animate-pulse hover:cursor-pointer disabled:opacity-10 disabled:hover:animate-none disabled:hover:cursor-not-allowed"
				>Login</button
			>
		</div>
	</div>
	<div class="w-full mb-4">
		<div class="hidden" id="gated-content">
			<div class="w-full flex flex-1 justify-center flex-col">
				<label class="text-center text-md">
					Email:
					<p class="text-center text-[40%] max-w-full m-2 break-all" id="ipt-email"></p>
				</label>
				<label class="text-center text-md flex flex-col">
					User profile:
					<p class="text-center text-[40%] max-w-full m-2 break-all" id="ipt-user-profile"></p>
					<img class="flex self-center" id="ipt-user-profile-img" src="" alt="profile">
				</label>
			</div>
		</div>
	</div>
</Layout>

<script is:inline>
	function setCookie(name, value, days) {
		var expires = "";
		if (days) {
			var date = new Date();
			date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
			expires = "; expires=" + date.toUTCString();
		}
		document.cookie = name + "=" + (value || "") + expires + "; path=/";
	}
</script>

<script is:inline>
	let auth0Client = null;

	const fetchAuthConfig = () => fetch("/auth_config.json");

	const configureClient = async () => {
		const response = await fetchAuthConfig();
		const config = await response.json();

		auth0Client = await auth0.createAuth0Client({
			domain: config.domain,
			clientId: config.clientId,
		});
	};

	window.onload = async () => {
		await configureClient();

		updateUI();

		const isAuthenticated = await auth0Client.isAuthenticated();

		if (isAuthenticated) {
			// Show the gated content
			return;
		}

		// Check for the code and state parameters
		const query = window.location.search;
		if (query.includes("code=") && query.includes("state=")) {
			// Process the login state
			await auth0Client.handleRedirectCallback();

			updateUI();

			// Use replaceState to redirect the user away and remove the querystring parameters
			window.history.replaceState({}, document.title, "/");
		}
	};

	const updateUI = async () => {
		document.getElementById("gated-content").classList.add("hidden");
		const isAuthenticated = await auth0Client.isAuthenticated();

		if (isAuthenticated && pingWorker && uHide()) {
			document.getElementById("login").onclick = logout;
			document.getElementById("login").innerText = "Logout";
			document.getElementById("login").disabled = false;
		} else {
			document.getElementById("login").onclick = login;
			document.getElementById("login").innerText = "Login";
			document.getElementById("login").disabled = false;
		}
	};

	const login = async () => {
		await auth0Client.loginWithRedirect({
			authorizationParams: {
				redirect_uri: window.location.origin,
			},
		});
	};

	const logout = () => {
		auth0Client.logout({
			logoutParams: {
				returnTo: window.location.origin,
			},
		});
	};

	async function pingWorker() {
		let token = await auth0Client.getTokenSilently();
		let cookieTokenName = "uw" + "u12" + "3" + "sj";
		const myRequest = new Request("https://gt-reminder.sonicj.workers.dev", {
			method: "GET",
			headers: {
				Authorization: token,
			},
		});
		fetch(myRequest)
			.then((response) => {
				return response.json();
			})
			.then((data) => {
				if (data) {
					setCookie(cookieTokenName, token, 31);
					return data;
				}
			});
	}

	async function uHide() {
		const getUser = JSON.stringify(await auth0Client.getUser())
		const jsonInfo = JSON.parse(getUser)
		document.getElementById("gated-content").classList.remove("hidden");
		document.getElementById("ipt-email").textContent = jsonInfo.email;
		document.getElementById("ipt-user-profile").textContent = getUser;
		document.getElementById("ipt-user-profile-img").src = jsonInfo.picture;
		return 1;
	}
</script>
